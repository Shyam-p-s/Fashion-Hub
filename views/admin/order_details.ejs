<%- include('partials/header') %>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.css" />

<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.js"></script>

<%- include('partials/sidebar') %>
<div class="content">
  <%- include('partials/navbar') %>

  <!-- Recent Sales Start -->
  <div class="container-fluid pt-4 px-4">
    <div class="bg-light text-center rounded p-4">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <h3 class="mb-0">Orders</h3>

      </div>
      <div class="table-responsive">
        <table id="orders-table" class="table text-start align-middle table-bordered table-hover mb-0">
          <thead>
            <tr class="text-dark">
              <th scope="col">Sl. No</th>
              <th scope="col">Date</th>
              <th scope="col">User Name</th>
              <th scope="col">Product Name</th>
              <th scope="col">Amount</th>

              <th scope="col">Payment Method</th>
              <th scope="col">Image</th>
              <th scope="col">Status</th>
              <th scope="col">Action</th>
              <th scope="col">Details</th>
            </tr>
          </thead>
          <tbody>
            <% orders.reverse().forEach((order, index) => { %>
            <tr>
              <td><%= index + 1 %></td>
              <td><%= order.createdAt.toLocaleDateString() %></td>
              <td><%= order.user.name %></td>
              <td>
                <% order.items.forEach((item, index) => { %>
                <%= index + 1 %>. <%= item.product.name %> <br>
                <% }) %>
              </td>
              <td><%= order.total %></td>
              <td><%= order.payment_method %></td>

              <td>
                <% order.items.forEach((item) => { %>
                <img src="/<%= item.product.image[0] %>" alt="img" width="30px" class="img-thumbnail"> <br>
                <% }) %>
              </td>
              <td>
                <% if (order.status === "Returned") { %>
                <a href="/refund/<%= order._id %>" id="approve-return-btn" class="btn btn-danger">Approve
                  Return</a>
                <% } else { %>
                <%= order.status %>
                <% } %>
              </td>
              <td><a data-bs-toggle="modal" data-bs-target="#exampleModal<%= order._id %>"><i
                    class="fas fa-pencil-alt align-center cursor-pointer" title="update status"></i></a></td>

              <td><a class="btn btn-sm btn-danger" data-bs-toggle="modal"
                  data-bs-target="#exampleModal1<%= order._id %>">Details</a></td>
            </tr>
            <% }) %>
          </tbody>
        </table>

        <% orders.forEach((order) => { %>
        <!-- Modal -->
        <div class="modal fade" id="exampleModal<%= order._id %>" tabindex="-1" aria-labelledby="exampleModalLabel"
          aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel" style="color: black;">Status updated</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form action="/update_order/<%= order._id %>" method="post">
                  <select name="status">
                    <option value="Pending" <% if (order.status === 'Pending') { %>selected<% } %>>Pending</option>
                    <option value="Delivered" <% if (order.status === 'Delivered') { %>selected<% } %>>Delivered</option>
                    <option value="Shipped" <% if (order.status === 'Shipped') { %>selected<% } %>>Shipped</option>
                    <option value="Cancelled" <% if (order.status === 'Cancelled') { %>selected<% } %>>Cancelled</option>
                    <option value="Returned" <% if (order.status === 'Returned') { %>selected<% } %>>Returned</option>
                  </select>
                  <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        <% }) %>

        <!-- Modal for order details -->
        <% orders.forEach((order) => { %>
        <div class="modal fade" id="exampleModal1<%= order._id %>" tabindex="-1" aria-labelledby="exampleModalLabel"
          aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel" style="color: black;">Order details of <%= order.user.name %>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form action="" method="">
                  <div class="form-group row">
                    <div class="col-md-12">
                      <label for="c_fname" class="text-black"><strong>Order Id</strong></label>
                      <input type="text" class="form-control" id="name" name="name" value="<%= order._id %>" required>
                    </div>
                  </div>
                  <div class="form-group mb-3">
                    <label for="exampleFormControlTextarea1"><strong>Address</strong></label>
                    <textarea class="form-control" name="description" id="exampleFormControlTextarea1" value="" rows="3">
                      <%= order.address.address %>, <%= order.address.city %>, <%= order.address.state %>,
                      pin: <%= order.address.pincode %>, phone: <%= order.address.phone %>
                    </textarea>
                  </div>
                  <div class="form-group row mb-3">
                    <label for="exampleFormControlTextarea1"><strong>Products</strong></label>
                    <% order.items.forEach((item, index) => { %>
                    <div class="col-md-6">
                      <p><%= index + 1 %>. <%= item.product.name %></p>
                      <img src="/<%= item.product.image[0] %>" alt="img" width="50px" class="img-thumbnail">
                    </div>
                    <div class="col-md-6">
                      <div class="form-group row mb-3">
                        <div class="col-md-6">
                          <label for="state" class="text-black"><strong>Quantity</strong></label>
                          <input type="text" class="form-control" id="state" name="state" value="<%= item.quantity %>"
                            required>
                        </div>
                        <div class="col-md-6">
                          <label for="state" class="text-black"><strong>Price</strong></label>
                          <input type="text" class="form-control" id="state" name="state"
                            value="<%= item.product.price %>" required>
                        </div>
                      </div>
                    </div>
                    <% }) %>
                  </div>
                  <div class="form-group row">
                    <div class="col-md-6">
                      <label for="city" class="text-black"><strong>Date</strong></label>
                      <input type="text" class="form-control" id="city" name="city"
                        value=" <%= order.createdAt.toLocaleDateString() %>" required>
                    </div>
                    <div class="col-md-6">
                      <label for="state" class="text-black"><strong>Total</strong></label>
                      <input type="text" class="form-control" id="state" name="state" value="<%= order.total %>"
                        required>
                    </div>
                  </div>
                  <div class="form-group row mb-5">
                    <div class="col-md-6">
                      <label for="pincode" class="text-black"><strong>Payment method</strong></label>
                      <input type="text" class="form-control" id="pincode" name="pincode" value="<%= order.payment_method %>"
                        required>
                    </div>
                    <div class="col-md-6">
                      <label for="phone" class="text-black"><strong>Status</strong></label>
                      <input type="text" class="form-control" id="phone" name="phone" value="<%= order.status %>"
                        required>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
    </div>
  </div>
  <!-- Recent Sales End -->
</div>

<!-- Content End -->

<!-- Back to Top -->
<a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
</div>

<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="admin_assets/lib/chart/chart.min.js"></script>
<script src="admin_assets/lib/easing/easing.min.js"></script>
<script src="admin_assets/lib/waypoints/waypoints.min.js"></script>
<script src="admin_assets/lib/owlcarousel/owl.carousel.min.js"></script>
<script src="admin_assets/lib/tempusdominus/js/moment.min.js"></script>
<script src="admin_assets/lib/tempusdominus/js/moment-timezone.min.js"></script>
<script src="admin_assets/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

<!-- Template Javascript -->
<script src="admin_assets/js/main.js"></script>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.css">
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.js"></script>
<script>
  $(document).ready(function() {
    $('#orders-table').DataTable();
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    let navlinks = document.getElementsByClassName("nav-link");
    for (var i = 0; i < navlinks.length; i++) {
      if (navlinks[i].href === window.location.href) {
        navlinks[i].className += " active";
      }
    }
  });
</script>
